{% extends "base.html" %}
{% load custom_tags %}

{% block head_title %}{{ document.title }}{% endblock head_title %}

{% block content %}

<div class="container-fluid py-4"> <!-- Document Header -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1">
                    <h1 class="h3 mb-2">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        {{ document.title|default:"Untitled Document" }}
                    </h1>
                    <div class="d-flex gap-3 flex-wrap align-items-center" id="status-badge">
                        <!-- Added id="status-badge" here -->
                        Status:
                        <span class="badge 
                            {% if document.status == 'COMPLETED' %}
                                bg-success 
                            {% elif document.status == 'PROCESSING' %}
                                bg-warning 
                            {% elif document.status == 'PENDING' %}
                                bg-info 
                            {% else %}
                                bg-danger 
                            {% endif %}">
                            {{ document.get_status_display }}
                        </span>
                        <p class="text-white-50 small mb-0">
                            <i class="bi bi-calendar3 me-1"></i>
                            {{ document.created_at|date:"M d, Y" }}
                        </p>
                        <p class="text-white-50 small mb-0"> <i class="bi bi-file-text me-1"></i> Source:
                            {% if document.source_type == 'FILE' %}File Upload
                            {% elif document.source_type == 'URL' %}Webpage URL
                            {% elif document.source_type == 'TEXT' %}Raw Text Input
                            {% else %}{{ document.source_type }}
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div>
                    <a href="{% url 'document_processing:document_list' %}" class="btn btn-outline-primary me-2 special-button">
                        <i class="bi bi-arrow-left me-1"></i>Back to Documents
                    </a>
                    {% if can_share %}
                    <button class="btn btn-outline-primary"
                        onclick="openShareModal({{ document.id }}, '{{ document.title|escapejs }}')" type="button">
                        <i class="bi bi-share me-1"></i>Share
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Pages List -->
    <div id="pages">
        {% if document.status == 'COMPLETED' %}
        {% if pages %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for p in pages %}
            <div class="col">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-file-earmark me-2"></i>Page {{ p.page_number }}
                        </h5>
                        <p class="card-text text-white-50 small">
                            {% if p.markdown_content %}
                            {{ p.markdown_content|truncatewords:20|md_to_html|striptags }}
                            {% else %}
                            No content available
                            {% endif %}
                        </p>
                    </div>
                    <div class="card-footer bg-transparent border-0">
                        <a href="{% url 'document_processing:page_detail' document.id p.page_number %}"
                            class="btn btn-sm btn-outline-primary w-100">
                            <i class="bi bi-eye me-1"></i>View Page
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info text-center py-5">
            <i class="bi bi-exclamation-triangle display-1 d-block mb-3"></i>
            <h4>No pages found</h4>
            <p class="mb-0">This document doesn't contain any pages.</p>
        </div>
        {% endif %}
        {% elif document.status == 'PROCESSING' %}
        <div class="alert alert-info text-center py-5">
            <div class="d-flex align-items-center justify-content-center">
                <div class="spinner-border text-primary me-3" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <div class="text-start">
                    <strong>Processing document...</strong>
                    <p class="mb-0 small">
                        This may take a few moments. The page will automatically refresh when ready.
                    </p>
                </div>
            </div>
        </div>
        {% elif document.status == 'FAILED' %}
        <div class="alert alert-danger text-center py-5">
            <i class="bi bi-x-circle display-1 d-block mb-3"></i>
            <h4>Processing failed</h4>
            <p class="mb-3">
                {% if document.error_message %}
                {{ document.error_message }}
                {% else %}
                Please try uploading the document again.
                {% endif %}
            </p>
            <div class="d-flex justify-content-center gap-2">
                <button id="retry-btn" class="btn btn-primary" onclick="retryDocument()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Retry Processing
                </button>
                <a href="{% url 'document_processing:document_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Documents
                </a>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info text-center py-5">
            <i class="bi bi-hourglass-split display-1 d-block mb-3"></i>
            <h4>Document pending</h4>
            <p class="mb-0">Document is pending processing.</p>
        </div>
        {% endif %}
    </div>
</div><!-- Include Share Modal -->
{% include "document_processing/document_share_modal.html" %}

<script>
    // Poll every 2 seconds until status becomes COMPLETED or FAILED
    const docId = {{ document.id }};
    const statusBadge = document.getElementById("status-badge");
    const pagesEl = document.getElementById("pages");

    function retryDocument() {
        const retryBtn = document.getElementById("retry-btn");
        const originalText = retryBtn.innerHTML;
        
        // Disable button and show loading state
        retryBtn.disabled = true;
        retryBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Retrying...';
        
        fetch("{% url 'document_processing:document_retry' document.id %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message and reload page
                alert("Document retry has been queued. Processing will begin shortly.");
                window.location.reload();
            } else {
                // Show error message
                alert("Failed to retry document: " + data.error);
                // Re-enable button
                retryBtn.disabled = false;
                retryBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error("Retry error:", error);
            alert("An error occurred while retrying the document.");
            // Re-enable button
            retryBtn.disabled = false;
            retryBtn.innerHTML = originalText;
        });
    }

    function checkStatus() {
        fetch("{% url 'document_processing:status_api' document.id %}")
            .then(r => r.json())
            .then(data => {
                // Update status badge
                let badgeClass = 'bg-secondary';  // Changed to 'bg-' classes to match theme
                if (data.status === 'Text Ready') {
                    badgeClass = 'bg-success';
                } else if (data.status === 'Processing Text') {
                    badgeClass = 'bg-warning';
                } else if (data.status === 'Failed') {
                    badgeClass = 'bg-danger';
                } else if (data.status === 'Pending') {  // Added for consistency
                    badgeClass = 'bg-info';
                }

                statusBadge.innerHTML = `Status: <span class="badge rounded-pill ${badgeClass}">${data.status}</span>`;

                if (data.status === "Text Ready") {
                    // Reload the page to fetch pages list
                    window.location.reload();
                }
                else if (data.status === "Failed") {  // Fixed: was "FAILED", now "Failed"
                    pagesEl.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i> 
                            <strong>Processing failed.</strong> 
                            ${data.error ? '<p class="mb-0">' + data.error + '</p>' : 'Please try uploading the document again.'}
                        </div>
                    `;
                }
            })
            .catch(console.error);
    }

    {% if document.status == 'PROCESSING' or document.status == 'PENDING' %}
    // Poll for status updates
    const pollInterval = setInterval(checkStatus, 2000);

    // Stop polling after 5 minutes (failsafe)
    setTimeout(() => clearInterval(pollInterval), 300000);
    {% endif %}
</script>

<style>
    .card {
        transition: transform 0.2s;
    }

    .card:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock content %}