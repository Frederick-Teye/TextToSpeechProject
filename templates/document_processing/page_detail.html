{% extends "base.html" %}
{% load custom_tags %}

{% block head_title %}Page {{ page.page_number }} - {{ page.document.title }}{% endblock head_title %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Main Content Area (Left Side) -->
        <div class="col-lg-8">
            <!-- Page Header -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h1 class="h3 mb-2">
                                <i class="bi bi-file-earmark-text me-2"></i> {{ page.document.title }}
                            </h1>
                            <h5 class="text-white-50">
                                <i class="bi bi-file-earmark me-2"></i> Page {{ page.page_number }}
                            </h5>
                        </div>
                        <a href="{% url 'document_processing:document_detail' page.document.id %}"
                            class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left me-1"></i> Back to Document
                        </a>
                    </div>
                </div>
            </div>

            <!-- Markdown Content -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0"><i class="bi bi-text-paragraph me-2"></i> Content</h5>
                </div>
                <div class="card-body markdown-content">
                    {{ page.markdown_content|md_to_html }}
                </div>
            </div>
        </div>

        <!-- Audio Player Sidebar (Right Side) -->
        <div class="col-lg-4">
            <div class="position-sticky" style="top: 20px;">
                <!-- Audio Player Card -->
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="mb-0">
                            <i class="bi bi-music-note-beamed me-2"></i> Audio Player
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Audio Player Component -->
                        <div id="audioPlayerContainer" class="mb-3">
                            <div id="noAudioMessage" class="text-center text-white-50 py-4">
                                <i class="bi bi-speaker display-6 d-block mb-2"></i>
                                <p class="mt-2 mb-0">No audio available yet</p>
                                <small>Generate audio to listen to this page</small>
                            </div>

                            <!-- Audio Player (Hidden initially) -->
                            <div id="audioPlayer" class="d-none">
                                <div class="mb-3">
                                    <label class="form-label small text-white-50">
                                        <i class="bi bi-mic me-1"></i> Playing: <strong id="currentVoice"></strong>
                                    </label>
                                    <audio id="audioElement" class="w-100" controls>
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>

                                <div class="d-flex gap-2">
                                    <button id="downloadBtn" class="btn btn-sm btn-outline-primary flex-fill"
                                        title="Download">
                                        <i class="bi bi-download me-1"></i> Download
                                    </button>
                                    <button id="deleteBtn" class="btn btn-sm btn-outline-danger"
                                        title="Delete (Owner Only)">
                                        <i class="bi bi-trash me-1"></i>
                                    </button>
                                </div>

                                <div class="mt-2 small text-white-50">
                                    <div><i class="bi bi-person me-1"></i> Generated by: <span id="generatedBy"></span>
                                    </div>
                                    <div><i class="bi bi-clock me-1"></i> Created: <span id="createdAt"></span></div>
                                    <div id="expiryInfo"><i class="bi bi-hourglass me-1"></i> Expires in: <span
                                            id="expiresIn"></span> days</div>
                                </div>
                            </div>
                        </div>

                        <!-- Voice Selector -->
                        <div id="voiceSelector" class="mb-3">
                            <label for="voiceSelect" class="form-label">
                                <i class="bi bi-mic-fill me-1"></i> Select Voice
                            </label>
                            <select id="voiceSelect" class="form-select border-0 shadow-sm">
                                <option value="">Loading voices...</option>
                            </select>
                        </div>

                        <!-- Generate Button -->
                        <button id="generateBtn" class="btn btn-primary w-100 mb-3" disabled>
                            <i class="bi bi-play-circle me-2"></i> Generate Audio
                        </button>

                        <!-- Generation Progress -->
                        <div id="generationProgress" class="alert alert-info d-none">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Generating...</span>
                                </div>
                                <div>
                                    <strong>Generating audio...</strong>
                                    <p class="mb-0 small" id="progressMessage">This may take a moment</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quota Card -->
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-header bg-transparent border-0">
                        <h6 class="mb-0">
                            <i class="bi bi-speedometer2 me-2"></i> Audio Quota
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-white-50">Used:</span>
                            <strong><span id="quotaUsed">-</span> / <span id="quotaMax">-</span></strong>
                        </div>
                        <div class="progress mb-2" style="height: 10px;">
                            <div id="quotaProgress" class="progress-bar" role="progressbar" style="width: 0%"
                                aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-white-50">
                            <span id="quotaAvailable">-</span> audio(s) remaining
                        </small>
                    </div>
                </div>

                <!-- Available Audios List -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-transparent border-0">
                        <h6 class="mb-0">
                            <i class="bi bi-collection me-2"></i> Available Audios (<span id="audioCount">0</span>)
                        </h6>
                    </div>
                    <div class="card-body" id="audiosList">
                        <div class="text-center text-white-50 py-2">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

<style>
    .markdown-content {
        line-height: 1.8;
        font-size: 1.05rem;
    }

    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }

    .markdown-content p {
        margin-bottom: 1rem;
    }

    .markdown-content code {
        background-color: #2d3238;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
    }

    .markdown-content pre {
        background-color: #2d3238;
        padding: 1rem;
        border-radius: 5px;
        overflow-x: auto;
    }

    .audio-item {
        border-bottom: 1px solid #495057;
        padding: 0.75rem 0;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .audio-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    .audio-item:last-child {
        border-bottom: none;
    }

    .audio-item.active {
        background-color: rgba(13, 110, 253, 0.1);
    }

    @media (max-width: 991px) {
        .position-sticky {
            position: static !important;
        }
    }
</style>

<script>
    const pageId = {{ page.id }};
    const documentId = {{ page.document.id }};
    let currentAudioId = null;
    let availableAudios = [];
    let isOwner = false;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadPageAudios();
    });

    // Load all audios for this page
    async function loadPageAudios() {
            try {
                const response = await fetch(`/speech/page/${pageId}/audios/`);
                const data = await response.json();

                if (data.success) {
                    availableAudios = data.audios;
                    isOwner = data.is_owner;

                    // Update quota display
                    updateQuotaDisplay(data.quota);

                    // Update voice selector with available voices
                    updateVoiceSelector(data.voices.available, data.quota.available, data.preferred_voice);

                    // Update audios list
                    updateAudiosList(data.audios);

                    // If there are audios, load the first one
                    if (data.audios.length > 0) {
                        loadAudio(data.audios[0]);
                    }
                } else {
                    showToast('error', data.error || 'Failed to load audios');
                }
            } catch (error) {
                showToast('error', 'Failed to load audios');
            }
        }

    // Update quota display
    function updateQuotaDisplay(quota) {
        document.getElementById('quotaUsed').textContent = quota.used;
        document.getElementById('quotaMax').textContent = quota.max;
        document.getElementById('quotaAvailable').textContent = quota.available;
        
        const percentage = (quota.used / quota.max) * 100;
        const progressBar = document.getElementById('quotaProgress');
        progressBar.style.width = percentage + '%';
        progressBar.setAttribute('aria-valuenow', percentage);
        
        // Color code based on usage
        progressBar.className = 'progress-bar';
        if (percentage >= 100) {
            progressBar.classList.add('bg-danger');
        } else if (percentage >= 75) {
            progressBar.classList.add('bg-warning');
        } else {
            progressBar.classList.add('bg-success');
        }
    }

    // Update voice selector
    function updateVoiceSelector(availableVoices, quotaAvailable, preferredVoice = '') {
        const select = document.getElementById('voiceSelect');
        const generateBtn = document.getElementById('generateBtn');
        
        select.innerHTML = '';
        
        if (quotaAvailable === 0) {
            select.innerHTML = '<option value="">Quota limit reached</option>';
            generateBtn.disabled = true;
            return;
        }
        
        if (availableVoices.length === 0) {
            select.innerHTML = '<option value="">All voices used</option>';
            generateBtn.disabled = true;
            return;
        }
        
        select.innerHTML = '<option value="">-- Select a voice --</option>';
        availableVoices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice;
            option.textContent = voice;
            if (voice == preferredVoice) {
                option.selected = true;  // Preselect if available and not used
            }
            select.appendChild(option);
        });
        
        // generateBtn.disabled = false;
        generateBtn.disabled = !select.value;
        
        // Enable generate button when voice selected
        select.addEventListener('change', async function() {
            generateBtn.disabled = !this.value;

            // Save preference if changed
            if (this.value) {
                try {
                    await fetch('/users/update-voice-preference/', {
                        method: 'POST',
                        headers: {
                            'Context-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({voice_id: this.value})
                    });
                } catch (error) {
                    console.error('Failed to save preference:', error);
                }
            }
        });
    }

    // Update audios list
    function updateAudiosList(audios) {
        const container = document.getElementById('audiosList');
        const countEl = document.getElementById('audioCount');
        
        countEl.textContent = audios.length;
        
        if (audios.length === 0) {
            container.innerHTML = '<p class="text-white-50 small mb-0">No audios generated yet</p>';
            return;
        }
        
        container.innerHTML = audios.map(audio => `
            <div class="audio-item" data-audio-id="${audio.id}" onclick="loadAudioById(${audio.id})">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong><i class="bi bi-mic"></i> ${audio.voice}</strong>
                        ${audio.status === 'GENERATING' ? '<span class="badge bg-warning ms-2">Generating...</span>' : ''}
                        ${audio.status === 'FAILED' ? '<span class="badge bg-danger ms-2">Failed</span>' : ''}
                        ${audio.status === 'COMPLETED' ? '<i class="bi bi-check-circle-fill text-success ms-2"></i>' : ''}
                    </div>
                    ${audio.status === 'COMPLETED' ? '<i class="bi bi-play-circle"></i>' : ''}
                </div>
                <small class="text-white-50 d-block mt-1">
                    ${audio.generated_by}
                </small>
            </div>
        `).join('');
    }

    // Load audio by ID
    function loadAudioById(audioId) {
        const audio = availableAudios.find(a => a.id === audioId);
        if (audio) {
            loadAudio(audio);
        }
    }

    // Load audio into player
    function loadAudio(audio) {
        if (audio.status !== 'COMPLETED') {
            return;
        }
        
        currentAudioId = audio.id;
        
        // Show player, hide "no audio" message
        document.getElementById('noAudioMessage').classList.add('d-none');
        document.getElementById('audioPlayer').classList.remove('d-none');
        
        // Set audio source
        const audioElement = document.getElementById('audioElement');
        audioElement.src = audio.s3_url;
        
        // Update metadata
        document.getElementById('currentVoice').textContent = audio.voice;
        document.getElementById('generatedBy').textContent = audio.generated_by;
        document.getElementById('createdAt').textContent = new Date(audio.created_at).toLocaleDateString();
        
        // Update expiry info
        if (audio.days_until_expiry !== null) {
            document.getElementById('expiryInfo').classList.remove('d-none');
            document.getElementById('expiresIn').textContent = audio.days_until_expiry;
        } else {
            document.getElementById('expiryInfo').classList.add('d-none');
        }
        
        // Show/hide delete button based on ownership
        document.getElementById('deleteBtn').style.display = isOwner ? 'block' : 'none';
        
        // Highlight active audio in list
        document.querySelectorAll('.audio-item').forEach(item => {
            item.classList.remove('active');
            if (parseInt(item.dataset.audioId) === currentAudioId) {
                item.classList.add('active');
            }
        });
        
        // Track play
        audioElement.addEventListener('play', function() {
            trackPlay(currentAudioId);
        }, { once: true });
    }

    // Generate audio
    document.getElementById('generateBtn').addEventListener('click', async function() {
        const voice = document.getElementById('voiceSelect').value;
        
        if (!voice) {
            showToast('error', 'Please select a voice');
            return;
        }
        
        // Show progress
        document.getElementById('generationProgress').classList.remove('d-none');
        this.disabled = true;
        
        try {
            const response = await fetch(`/speech/generate/${pageId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ voice_id: voice })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('success', data.message);
                // Poll for status
                pollAudioStatus(data.audio_id);
            } else {
                showToast('error', data.error);
                document.getElementById('generationProgress').classList.add('d-none');
                this.disabled = false;
            }
        } catch (error) {
            console.error('Error generating audio:', error);
            showToast('error', 'Failed to generate audio');
            document.getElementById('generationProgress').classList.add('d-none');
            this.disabled = false;
        }
    });

    // Poll audio generation status
    async function pollAudioStatus(audioId) {
        const maxAttempts = 60;  // 2 minutes max
        let attempts = 0;
        
        const interval = setInterval(async () => {
            attempts++;
            
            if (attempts > maxAttempts) {
                clearInterval(interval);
                document.getElementById('generationProgress').classList.add('d-none');
                document.getElementById('generateBtn').disabled = false;
                showToast('error', 'Generation timeout. Please refresh the page.');
                return;
            }
            
            try {
                const response = await fetch(`/speech/audio/${audioId}/status/`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.status === 'COMPLETED') {
                        clearInterval(interval);
                        document.getElementById('generationProgress').classList.add('d-none');
                        showToast('success', 'Audio generated successfully!');
                        // Reload audios
                        loadPageAudios();
                    } else if (data.status === 'FAILED') {
                        clearInterval(interval);
                        document.getElementById('generationProgress').classList.add('d-none');
                        document.getElementById('generateBtn').disabled = false;
                        showToast('error', 'Audio generation failed: ' + (data.error_message || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }, 2000);  // Poll every 2 seconds
    }

    // Download audio
    document.getElementById('downloadBtn').addEventListener('click', async function() {
        if (!currentAudioId) return;
        
        try {
            const response = await fetch(`/speech/audio/${currentAudioId}/download/`);
            const data = await response.json();
            
            if (data.success) {
                // Open download URL in new tab
                window.open(data.download_url, '_blank');
                showToast('success', 'Download started');
            } else {
                showToast('error', data.error);
            }
        } catch (error) {
            console.error('Error downloading audio:', error);
            showToast('error', 'Failed to download audio');
        }
    });

    // Delete audio
    document.getElementById('deleteBtn').addEventListener('click', async function() {
        if (!currentAudioId) return;
        
        if (!confirm('Are you sure you want to delete this audio? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/speech/audio/${currentAudioId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('success', data.message);
                currentAudioId = null;
                // Reload audios
                loadPageAudios();
                // Hide player
                document.getElementById('noAudioMessage').classList.remove('d-none');
                document.getElementById('audioPlayer').classList.add('d-none');
            } else {
                showToast('error', data.error);
            }
        } catch (error) {
            console.error('Error deleting audio:', error);
            showToast('error', 'Failed to delete audio');
        }
    });

    // Track play
    async function trackPlay(audioId) {
        try {
            await fetch(`/speech/audio/${audioId}/play/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
        } catch (error) {
            console.error('Error tracking play:', error);
        }
    }

    // Utility: Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Utility: Show toast notification
    function showToast(type, message) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        setTimeout(() => toast.remove(), 5000);
    }
</script>
{% endblock content %}
