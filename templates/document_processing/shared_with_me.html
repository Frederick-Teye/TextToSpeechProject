{% extends "base.html" %}
{% load static %}

{% block head_title %}Shared with Me{% endblock head_title %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-people-fill"></i> Shared with Me</h2>
        <a href="{% url 'document_processing:document_list' %}" class="btn btn-outline-primary">
            <i class="bi bi-file-earmark-text"></i> My Documents
        </a>
    </div>

    <!-- Toast Container for notifications -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-white-50 mt-3">Loading shared documents...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-5 d-none">
        <i class="bi bi-inbox" style="font-size: 4rem; color: #6c757d;"></i>
        <h4 class="mt-3 text-white-50">No Documents Shared with You</h4>
        <p class="text-white-50">When someone shares a document with you, it will appear here.</p>
    </div>

    <!-- Documents List -->
    <div id="documentsContainer" class="d-none">
        <div class="row" id="documentsList">
            <!-- Documents will be loaded here via JavaScript -->
        </div>
    </div>
</div>

<script>
    // Load shared documents on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadSharedDocuments();
    });

    async function loadSharedDocuments() {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const documentsContainer = document.getElementById('documentsContainer');
        const documentsList = document.getElementById('documentsList');

        try {
            const response = await fetch('/speech/shared-with-me/', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            // Hide loading state
            loadingState.classList.add('d-none');

            if (data.success) {
                if (data.documents.length === 0) {
                    emptyState.classList.remove('d-none');
                } else {
                    documentsContainer.classList.remove('d-none');
                    documentsList.innerHTML = data.documents.map(item => createDocumentCard(item)).join('');
                }
            } else {
                documentsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> ${data.error}
                        </div>
                    </div>
                `;
                documentsContainer.classList.remove('d-none');
            }
        } catch (error) {
            console.error('Error loading shared documents:', error);
            loadingState.classList.add('d-none');
            documentsContainer.classList.remove('d-none');
            documentsList.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Failed to load shared documents
                    </div>
                </div>
            `;
        }
    }

    function createDocumentCard(item) {
        const doc = item.document;
        const permission = item.permission;
        const canGenerate = item.can_generate_audio;
        const canShare = item.can_share;

        // Permission badge
        let permissionBadge = '';
        let permissionColor = '';
        if (permission === 'VIEW_ONLY') {
            permissionBadge = 'View Only';
            permissionColor = 'secondary';
        } else if (permission === 'COLLABORATOR') {
            permissionBadge = 'Collaborator';
            permissionColor = 'info';
        } else if (permission === 'CAN_SHARE') {
            permissionBadge = 'Can Share';
            permissionColor = 'success';
        }

        // Status badge
        let statusBadge = '';
        let statusColor = '';
        if (doc.status === 'COMPLETED') {
            statusBadge = 'Ready';
            statusColor = 'success';
        } else if (doc.status === 'PENDING' || doc.status === 'PROCESSING') {
            statusBadge = 'Processing';
            statusColor = 'warning';
        } else {
            statusBadge = 'Failed';
            statusColor = 'danger';
        }

        return `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card bg-secondary h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-file-earmark-text"></i> ${doc.title}
                            </h5>
                            <span class="badge bg-${permissionColor}">${permissionBadge}</span>
                        </div>
                        <p class="card-text text-white-50 small mb-2">
                            <i class="bi bi-person"></i> Owner: ${doc.owner.name}
                        </p>
                        <p class="card-text text-white-50 small mb-2">
                            <i class="bi bi-share"></i> Shared by: ${item.shared_by.name}
                        </p>
                        <p class="card-text text-white-50 small mb-3">
                            <i class="bi bi-clock"></i> ${formatDate(item.shared_at)}
                        </p>
                        
                        <div class="d-flex gap-2 mb-2">
                            <span class="badge bg-${statusColor}">
                                <i class="bi bi-circle-fill"></i> ${statusBadge}
                            </span>
                            ${canGenerate ? '<span class="badge bg-info"><i class="bi bi-mic"></i> Can Generate</span>' : ''}
                            ${canShare ? '<span class="badge bg-success"><i class="bi bi-share"></i> Can Share</span>' : ''}
                        </div>
                    </div>
                    <div class="card-footer bg-dark border-secondary">
                        <div class="d-flex gap-2">
                            ${doc.status === 'COMPLETED' ? `
                                <a href="{% url 'document_processing:document_detail' 0 %}".replace('0', doc.id) 
                                   class="btn btn-sm btn-primary flex-fill">
                                    <i class="bi bi-eye"></i> View
                                </a>
                            ` : `
                                <button class="btn btn-sm btn-secondary flex-fill" disabled>
                                    <i class="bi bi-hourglass-split"></i> Processing
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function formatDate(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        if (diffDays < 30) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        
        return date.toLocaleDateString();
    }

    // Utility: Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<style>
    .card {
        transition: transform 0.2s;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .badge {
        font-size: 0.75rem;
    }
</style>
{% endblock content %}
