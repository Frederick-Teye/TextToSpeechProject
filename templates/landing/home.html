{% extends "base.html" %}
{% load static %}

{% block head_title %}Home - TTS Document Converter{% endblock head_title %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Welcome Section -->
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold mb-3">Welcome to TTS Document Converter</h1>
            <p class="lead fs-4">
                Your free and accessible text-to-speech conversion tool. Transform your documents into natural-sounding audio with ease.
            </p>
        </div>

        <!-- Voice Selection Card -->
        <div class="card shadow-lg border-0">
            <div class="card-header bg-primary text-white py-3">
                <h2 class="h4 mb-0"><i class="bi bi-megaphone me-2"></i>Choose Your Preferred Voice</h2>
            </div>
            <div class="card-body p-4">
                <p class="text-white-50 mb-4">
                    Select a voice for text-to-speech conversion. You can preview each voice before making your selection.
                    This preference will be saved to your profile.
                </p>

                <form id="voiceSelectionForm">
                    <div class="row align-items-end">
                        <div class="col-md-6">
                            <label for="voiceSelect" class="form-label fw-semibold">Select Voice</label>
                            <select class="form-select" id="voiceSelect" aria-label="Voice selection">
                                {% for voice_id, voice_name in standard_voices %}
                                    <option value="{{ voice_id }}" 
                                            {% if preferred_voice == voice_id %}selected{% endif %}>
                                        {{ voice_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <button type="button" id="previewVoiceBtn" class="btn btn-outline-primary w-100">
                                <i class="bi bi-play-circle me-2"></i>Preview Voice
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-check-circle me-2"></i>Save Voice Preference
                        </button>
                        <small class="text-white-50">Your selection will be automatically used for all audio generation.</small>
                    </div>
                </form>

                <!-- Status Messages -->
                <div id="voiceStatusMessage" class="alert mt-3" style="display: none;"></div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="row mt-5">
            <div class="col-md-4 mb-4">
                <div class="text-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="bi bi-upload fs-2 text-primary"></i>
                    </div>
                    <h4>Upload Documents</h4>
                    <p class="text-white-50">Upload PDFs, Word documents, or text files for conversion.</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="text-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="bi bi-soundwave fs-2 text-primary"></i>
                    </div>
                    <h4>Generate Audio</h4>
                    <p class="text-white-50">Convert your text to natural-sounding speech with your preferred voice.</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="text-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="bi bi-headphones fs-2 text-primary"></i>
                    </div>
                    <h4>Listen Anywhere</h4>
                    <p class="text-white-50">Access your audio files from any device, anytime.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
// Voice selection and preview functionality
document.addEventListener('DOMContentLoaded', function() {
    const voiceSelect = document.getElementById('voiceSelect');
    const previewVoiceBtn = document.getElementById('previewVoiceBtn');
    const voiceForm = document.getElementById('voiceSelectionForm');
    const voiceStatusMessage = document.getElementById('voiceStatusMessage');
    
    // Standard voices configuration
    const STANDARD_VOICES = {
        {% for voice_id, voice_name in standard_voices %}
        '{{ voice_id }}': '{{ voice_name }}',
        {% endfor %}
    };
    
    // Load saved voice preference from localStorage
    function loadVoicePreference() {
        const savedVoice = localStorage.getItem('preferredVoice');
        if (savedVoice && STANDARD_VOICES[savedVoice]) {
            voiceSelect.value = savedVoice;
        }
        return voiceSelect.value;
    }
    
    // Save voice preference to localStorage and profile (if authenticated)
    function saveVoicePreference(voiceId) {
        localStorage.setItem('preferredVoice', voiceId);
        
        // Show success message
        showStatusMessage(`Voice preference saved: ${STANDARD_VOICES[voiceId]}`, 'success');
        
        // If user is authenticated, save to profile via AJAX
        {% if user.is_authenticated %}
        fetch('{% url "users:update_voice_preference" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({ voice_id: voiceId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Voice preference saved to profile');
                showStatusMessage(`Voice preference saved to your profile: ${STANDARD_VOICES[voiceId]}`, 'success');
            }
        })
        .catch(error => {
            console.error('Error saving voice preference:', error);
            showStatusMessage('Error saving to profile, but saved locally', 'warning');
        });
        {% endif %}
    }
    
    // Audio file mapping for voice previews
    const VOICE_AUDIO_FILES = {
        'Ivy': 'Ivy.mp3',
        'Joanna': 'Joanna.mp3',
        'Joey': 'Joey.mp3',
        'Justin': 'Justin.mp3',
        'Kendra': 'Kendra.mp3',
        'Kimberly': 'Kimberly.mp3',
        'Matthew': 'Matthew.mp3',
        'Salli': 'Salli.mp3'
    };
    
    // Preview voice functionality
    previewVoiceBtn.addEventListener('click', function() {
        const selectedVoice = voiceSelect.value;
        
        if (VOICE_AUDIO_FILES[selectedVoice]) {
            playVoicePreview(selectedVoice);
        } else {
            showStatusMessage(`Audio preview not available for ${STANDARD_VOICES[selectedVoice]}`, 'warning');
        }
    });
    
    // Form submission
    voiceForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const selectedVoice = voiceSelect.value;
        saveVoicePreference(selectedVoice);
    });
    
    // Utility function to get CSRF token
    function getCSRFToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue || '';
    }
    
    // Utility function to show status messages
    function showStatusMessage(message, type) {
        voiceStatusMessage.textContent = message;
        voiceStatusMessage.className = `alert alert-${type}`;
        voiceStatusMessage.style.display = 'block';
        
        setTimeout(() => {
            voiceStatusMessage.style.display = 'none';
        }, 5000);
    }
    
    // Play voice preview with actual audio files
    function playVoicePreview(voiceId) {
        showStatusMessage(`Playing preview of ${STANDARD_VOICES[voiceId]}...`, 'info');
        
        // Stop any currently playing preview first
        let existingAudio = document.getElementById('backgroundPreviewAudio');
        if (existingAudio) {
            existingAudio.pause();
            existingAudio.currentTime = 0;
        }
        
        const audioFile = VOICE_AUDIO_FILES[voiceId];
        const audioUrl = `/static/landing/audio/${audioFile}`;
        
        console.log('Attempting to play audio from:', audioUrl); // Debug log
        console.log('Selected voice:', voiceId);
        console.log('Audio file mapping:', audioFile);
        
        // Create a hidden audio element for background playback
        let backgroundAudio = document.getElementById('backgroundPreviewAudio');
        if (!backgroundAudio) {
            backgroundAudio = document.createElement('audio');
            backgroundAudio.id = 'backgroundPreviewAudio';
            backgroundAudio.style.display = 'none';
            // Add CORS and preload attributes
            backgroundAudio.crossOrigin = 'anonymous';
            backgroundAudio.preload = 'auto';
            document.body.appendChild(backgroundAudio);
            console.log('Created new audio element');
        }
        
        // Add event listeners for debugging
        backgroundAudio.addEventListener('loadstart', () => console.log('Audio loading started'));
        backgroundAudio.addEventListener('loadeddata', () => console.log('Audio data loaded'));
        backgroundAudio.addEventListener('canplay', () => console.log('Audio can play'));
        backgroundAudio.addEventListener('error', (e) => {
            console.error('Audio error:', e);
            console.error('Audio error details:', backgroundAudio.error);
            showStatusMessage(`Audio error: ${backgroundAudio.error?.message || 'Unknown error'}`, 'danger');
        });
        
        // Set up the new audio
        backgroundAudio.src = audioUrl;
        console.log('Audio src set to:', backgroundAudio.src);
        backgroundAudio.load();
        
        // Try to play the audio with better error handling
        const playPromise = backgroundAudio.play();
        
        if (playPromise !== undefined) {
            playPromise
                .then(() => {
                    console.log('Audio playback started successfully');
                    showStatusMessage(`Playing ${STANDARD_VOICES[voiceId]} preview`, 'success');
                })
                .catch(error => {
                    console.error('Playback failed:', error);
                    if (error.name === 'NotAllowedError') {
                        showStatusMessage('Please click the page first to enable audio playback', 'warning');
                    } else {
                        showStatusMessage(`Error playing ${STANDARD_VOICES[voiceId]} preview: ${error.message}`, 'danger');
                    }
                });
        }
        
        // Clean up message when audio ends
        backgroundAudio.addEventListener('ended', function() {
            console.log('Audio playback ended');
            showStatusMessage(`${STANDARD_VOICES[voiceId]} preview completed`, 'info');
            setTimeout(() => {
                voiceStatusMessage.style.display = 'none';
            }, 2000);
        }, { once: true });
    }
    
    // Initialize voice preference on page load
    loadVoicePreference();
});
</script>
{% endblock extra_js %}