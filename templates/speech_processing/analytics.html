{% extends "base.html" %}

{% block head_title %}Analytics{% endblock head_title %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="bi bi-graph-up"></i> Analytics</h1>
            <p class="text-muted">Detailed usage statistics and trends</p>
        </div>
        <div class="col-auto">
            <select id="periodSelect" class="form-select bg-dark text-light border-secondary">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 90 Days</option>
            </select>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link" href="{% url 'dashboard:home' %}">
                <i class="bi bi-house"></i> Overview
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="{% url 'dashboard:analytics' %}">
                <i class="bi bi-graph-up"></i> Analytics
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'dashboard:errors' %}">
                <i class="bi bi-exclamation-triangle"></i> Errors
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'dashboard:activity' %}">
                <i class="bi bi-activity"></i> User Activity
            </a>
        </li>
    </ul>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading analytics data...</p>
    </div>

    <!-- Charts Container -->
    <div id="chartsContainer" class="d-none">
        <div class="row g-4">
            <!-- Audio Generation Trend -->
            <div class="col-lg-12">
                <div class="card bg-secondary">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Audio Generation Trend</h5>
                    </div>
                    <div class="card-body">
                        <div id="audioTrendChart" style="min-height: 300px;"></div>
                    </div>
                </div>
            </div>

            <!-- Voice Distribution -->
            <div class="col-lg-6">
                <div class="card bg-secondary">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Voice Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div id="voiceDistributionList"></div>
                    </div>
                </div>
            </div>

            <!-- Action Distribution -->
            <div class="col-lg-6">
                <div class="card bg-secondary">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Action Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div id="actionDistributionList"></div>
                    </div>
                </div>
            </div>

            <!-- Top Generators -->
            <div class="col-lg-6">
                <div class="card bg-secondary">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-trophy"></i> Top Audio Generators</h5>
                    </div>
                    <div class="card-body">
                        <div id="topGeneratorsList"></div>
                    </div>
                </div>
            </div>

            <!-- Top Active Users -->
            <div class="col-lg-6">
                <div class="card bg-secondary">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-star"></i> Most Active Users</h5>
                    </div>
                    <div class="card-body">
                        <div id="topActiveUsersList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPeriod = 30;

    // Load analytics data
    async function loadAnalytics(period) {
        document.getElementById('loadingIndicator').classList.remove('d-none');
        document.getElementById('chartsContainer').classList.add('d-none');

        try {
            const response = await fetch(`{% url 'dashboard:analytics_data' %}?period=${period}`);
            const data = await response.json();

            if (data.success) {
                renderCharts(data);
                document.getElementById('loadingIndicator').classList.add('d-none');
                document.getElementById('chartsContainer').classList.remove('d-none');
            }
        } catch (error) {
            console.error('Error loading analytics:', error);
            document.getElementById('loadingIndicator').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Failed to load analytics data
                </div>
            `;
        }
    }

    // Render all charts
    function renderCharts(data) {
        renderAudioTrendChart(data.audio_trend);
        renderVoiceDistribution(data.voice_distribution);
        renderActionDistribution(data.action_distribution);
        renderTopGenerators(data.top_generators);
        renderTopActiveUsers(data.top_active_users);
    }

    // Render audio trend chart (simple text-based for now)
    function renderAudioTrendChart(audioTrend) {
        const container = document.getElementById('audioTrendChart');
        
        if (!audioTrend || audioTrend.length === 0) {
            container.innerHTML = '<p class="text-muted">No data available</p>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-dark table-sm">';
        html += '<thead><tr><th>Date</th><th>Total</th><th>Completed</th><th>Failed</th></tr></thead><tbody>';
        
        audioTrend.forEach(item => {
            html += `<tr>
                <td>${item.date}</td>
                <td><span class="badge bg-primary">${item.total}</span></td>
                <td><span class="badge bg-success">${item.completed}</span></td>
                <td><span class="badge bg-danger">${item.failed}</span></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // Render voice distribution
    function renderVoiceDistribution(voiceData) {
        const container = document.getElementById('voiceDistributionList');
        
        if (!voiceData || voiceData.length === 0) {
            container.innerHTML = '<p class="text-muted">No data available</p>';
            return;
        }

        const total = voiceData.reduce((sum, item) => sum + item.count, 0);
        
        let html = '<div>';
        voiceData.forEach(item => {
            const percentage = Math.round((item.count / total) * 100);
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span><strong>${item.voice}</strong></span>
                        <span class="text-muted">${item.count} (${percentage}%)</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }

    // Render action distribution
    function renderActionDistribution(actionData) {
        const container = document.getElementById('actionDistributionList');
        
        if (!actionData || actionData.length === 0) {
            container.innerHTML = '<p class="text-muted">No data available</p>';
            return;
        }

        const total = actionData.reduce((sum, item) => sum + item.count, 0);
        
        let html = '<div>';
        actionData.forEach(item => {
            const percentage = Math.round((item.count / total) * 100);
            const iconMap = {
                'GENERATE': 'play-circle',
                'PLAY': 'play-fill',
                'DOWNLOAD': 'download',
                'DELETE': 'trash',
                'SHARE': 'share',
                'UNSHARE': 'x-circle'
            };
            const icon = iconMap[item.action] || 'circle';
            
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span><i class="bi bi-${icon}"></i> <strong>${item.action}</strong></span>
                        <span class="text-muted">${item.count} (${percentage}%)</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-info" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }

    // Render top generators
    function renderTopGenerators(generators) {
        const container = document.getElementById('topGeneratorsList');
        
        if (!generators || generators.length === 0) {
            container.innerHTML = '<p class="text-muted">No data available</p>';
            return;
        }

        let html = '<ol class="list-group list-group-numbered">';
        generators.forEach(item => {
            html += `
                <li class="list-group-item d-flex justify-content-between align-items-center bg-dark">
                    <span class="text-truncate">${item.generated_by__email}</span>
                    <span class="badge bg-primary rounded-pill">${item.count}</span>
                </li>
            `;
        });
        html += '</ol>';
        
        container.innerHTML = html;
    }

    // Render top active users
    function renderTopActiveUsers(users) {
        const container = document.getElementById('topActiveUsersList');
        
        if (!users || users.length === 0) {
            container.innerHTML = '<p class="text-muted">No data available</p>';
            return;
        }

        let html = '<ol class="list-group list-group-numbered">';
        users.forEach(item => {
            html += `
                <li class="list-group-item d-flex justify-content-between align-items-center bg-dark">
                    <span class="text-truncate">${item.user__email}</span>
                    <span class="badge bg-success rounded-pill">${item.count}</span>
                </li>
            `;
        });
        html += '</ol>';
        
        container.innerHTML = html;
    }

    // Period selector change handler
    document.getElementById('periodSelect').addEventListener('change', function() {
        currentPeriod = parseInt(this.value);
        loadAnalytics(currentPeriod);
    });

    // Load initial data
    document.addEventListener('DOMContentLoaded', function() {
        loadAnalytics(currentPeriod);
    });
</script>

<style>
    .nav-tabs .nav-link {
        color: #e0e6eb;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #212529;
        color: #fff;
        border-color: #495057 #495057 #212529;
    }
    
    .list-group-item {
        border-color: #495057;
    }
</style>
{% endblock content %}
